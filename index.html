<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ThumbAI â€” Create & Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #1a1a24;
    --surface3: #22222f;
    --accent: #7c5cfc;
    --accent2: #fc5c7d;
    --accent-glow: rgba(124,92,252,0.35);
    --text: #e8e8f0;
    --text-dim: #7a7a9a;
    --text-dimmer: #3a3a5a;
    --border: rgba(255,255,255,0.06);
    --border2: rgba(124,92,252,0.25);
    --radius: 14px;
    --sidebar-w: 270px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
  }

  /* â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #auth-screen {
    position: fixed; inset: 0;
    display: flex; align-items: center; justify-content: center;
    background: var(--bg);
    z-index: 100;
    overflow: hidden;
  }

  #auth-screen::before {
    content: '';
    position: absolute; inset: 0;
    background: radial-gradient(ellipse 60% 60% at 50% 0%, rgba(124,92,252,0.18) 0%, transparent 70%),
                radial-gradient(ellipse 40% 40% at 80% 80%, rgba(252,92,125,0.1) 0%, transparent 60%);
    pointer-events: none;
  }

  .auth-grid {
    position: absolute; inset: 0;
    background-image: 
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 40px 40px;
    mask-image: radial-gradient(ellipse 80% 80% at 50% 50%, black 40%, transparent 100%);
  }

  .auth-box {
    position: relative;
    width: 400px;
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 0 80px var(--accent-glow), 0 30px 60px rgba(0,0,0,0.6);
    animation: fadeUp 0.5s cubic-bezier(0.16,1,0.3,1) both;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(30px) scale(0.97); }
    to   { opacity: 1; transform: none; }
  }

  .auth-logo {
    font-family: 'Syne', sans-serif;
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -1px;
    margin-bottom: 6px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }

  .auth-tagline {
    color: var(--text-dim);
    font-size: 12px;
    margin-bottom: 32px;
  }

  .tab-row {
    display: flex;
    gap: 4px;
    background: var(--bg);
    border-radius: 10px;
    padding: 4px;
    margin-bottom: 28px;
  }

  .tab-btn {
    flex: 1;
    padding: 9px;
    border: none;
    background: transparent;
    color: var(--text-dim);
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border-radius: 7px;
    transition: all 0.2s;
  }
  .tab-btn.active {
    background: var(--accent);
    color: #fff;
    box-shadow: 0 4px 16px var(--accent-glow);
  }

  .auth-field {
    margin-bottom: 14px;
  }
  .auth-field label {
    display: block;
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 7px;
  }
  .auth-field input {
    width: 100%;
    padding: 12px 16px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .auth-field input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  .auth-submit {
    width: 100%;
    padding: 14px;
    margin-top: 8px;
    background: linear-gradient(135deg, var(--accent), #9b5fff);
    border: none;
    border-radius: 10px;
    color: #fff;
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.2s, opacity 0.2s;
    box-shadow: 0 6px 24px var(--accent-glow);
  }
  .auth-submit:hover { transform: translateY(-1px); box-shadow: 0 10px 30px var(--accent-glow); }
  .auth-submit:active { transform: translateY(0); }
  .auth-submit:disabled { opacity: 0.5; cursor: not-allowed; }

  .auth-error {
    color: var(--accent2);
    font-size: 12px;
    margin-top: 12px;
    text-align: center;
    min-height: 18px;
  }

  /* â”€â”€â”€ APP LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #app { display: flex; width: 100%; height: 100vh; }

  /* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #sidebar {
    width: var(--sidebar-w);
    min-width: var(--sidebar-w);
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 22px 18px 14px;
    border-bottom: 1px solid var(--border);
  }
  .sidebar-logo {
    font-family: 'Syne', sans-serif;
    font-size: 20px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 14px;
  }

  .new-chat-btn {
    width: 100%;
    padding: 10px 14px;
    background: linear-gradient(135deg, var(--accent), #9b5fff);
    border: none;
    border-radius: 10px;
    color: #fff;
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: transform 0.15s, box-shadow 0.2s;
    box-shadow: 0 4px 16px var(--accent-glow);
  }
  .new-chat-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 24px var(--accent-glow); }

  .chat-list-label {
    padding: 14px 18px 6px;
    font-size: 10px;
    color: var(--text-dimmer);
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }

  #chat-list {
    flex: 1;
    overflow-y: auto;
    padding: 4px 10px;
  }
  #chat-list::-webkit-scrollbar { width: 3px; }
  #chat-list::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 3px; }

  .chat-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 10px;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.15s;
    margin-bottom: 2px;
    position: relative;
    group: true;
  }
  .chat-item:hover { background: var(--surface2); }
  .chat-item.active { background: rgba(124,92,252,0.12); border: 1px solid rgba(124,92,252,0.2); }
  .chat-item-icon { font-size: 14px; flex-shrink: 0; }
  .chat-item-name {
    font-size: 12.5px;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
  }
  .chat-item.active .chat-item-name { color: var(--accent); }
  .chat-delete {
    opacity: 0;
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 13px;
    padding: 2px 4px;
    border-radius: 4px;
    transition: opacity 0.15s, color 0.15s;
    flex-shrink: 0;
  }
  .chat-item:hover .chat-delete { opacity: 1; }
  .chat-delete:hover { color: var(--accent2); }

  .sidebar-footer {
    padding: 14px 16px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .user-avatar {
    width: 34px; height: 34px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex; align-items: center; justify-content: center;
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 13px;
    color: #fff;
    flex-shrink: 0;
  }
  .user-info { flex: 1; overflow: hidden; }
  .user-name { font-size: 12.5px; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .user-sub { font-size: 10.5px; color: var(--text-dim); }
  .logout-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-size: 11px;
    padding: 5px 9px;
    border-radius: 7px;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    transition: border-color 0.15s, color 0.15s;
    flex-shrink: 0;
  }
  .logout-btn:hover { border-color: var(--accent2); color: var(--accent2); }

  /* â”€â”€â”€ MAIN AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
    background: var(--bg);
  }

  .chat-topbar {
    padding: 18px 28px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(10,10,15,0.8);
    backdrop-filter: blur(12px);
    flex-shrink: 0;
  }
  .chat-title {
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    color: var(--text);
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .chat-badge {
    padding: 4px 10px;
    background: rgba(124,92,252,0.12);
    border: 1px solid rgba(124,92,252,0.2);
    border-radius: 20px;
    font-size: 10.5px;
    color: var(--accent);
    letter-spacing: 0.5px;
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 28px 32px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  #messages::-webkit-scrollbar { width: 4px; }
  #messages::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 4px; }

  /* empty state */
  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    color: var(--text-dim);
    user-select: none;
  }
  .empty-icon { font-size: 52px; opacity: 0.4; }
  .empty-title { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 800; color: var(--text-dimmer); letter-spacing: -0.5px; }
  .empty-sub { font-size: 12px; color: var(--text-dimmer); text-align: center; max-width: 340px; line-height: 1.8; }
  .empty-tips {
    display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 8px;
  }
  .tip-chip {
    padding: 7px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 12px;
    color: var(--text-dim);
    cursor: pointer;
    transition: border-color 0.15s, color 0.15s, background 0.15s;
  }
  .tip-chip:hover { border-color: var(--accent); color: var(--accent); background: rgba(124,92,252,0.06); }

  /* messages */
  .msg {
    display: flex;
    gap: 14px;
    align-items: flex-start;
    animation: msgIn 0.3s cubic-bezier(0.16,1,0.3,1) both;
  }
  @keyframes msgIn {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: none; }
  }
  .msg.user { flex-direction: row-reverse; }

  .msg-avatar {
    width: 32px; height: 32px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .msg.ai .msg-avatar { background: linear-gradient(135deg, var(--accent), #9b5fff); }
  .msg.user .msg-avatar { background: linear-gradient(135deg, var(--accent2), #ff8a65); }

  .msg-bubble {
    max-width: 68%;
    padding: 13px 18px;
    border-radius: var(--radius);
    font-size: 13.5px;
    line-height: 1.75;
    position: relative;
  }
  .msg.ai .msg-bubble {
    background: var(--surface);
    border: 1px solid var(--border);
    border-top-left-radius: 4px;
    color: var(--text);
  }
  .msg.user .msg-bubble {
    background: linear-gradient(135deg, var(--accent), #9b5fff);
    border-top-right-radius: 4px;
    color: #fff;
  }

  /* thumbnail card */
  .thumb-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin-top: 12px;
    max-width: 420px;
  }
  .thumb-card img {
    width: 100%;
    aspect-ratio: 16/9;
    object-fit: cover;
    display: block;
    transition: opacity 0.3s;
  }
  .thumb-card img.loading { opacity: 0.3; filter: blur(8px); }
  .thumb-meta {
    padding: 10px 14px;
    display: flex; align-items: center; gap: 8px;
  }
  .thumb-label {
    font-size: 10.5px;
    color: var(--text-dim);
    flex: 1;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .thumb-dl {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    transition: border-color 0.15s, color 0.15s;
    text-decoration: none;
  }
  .thumb-dl:hover { border-color: var(--accent); color: var(--accent); }

  /* typing indicator */
  .typing-dots {
    display: flex; gap: 5px; padding: 6px 0;
  }
  .typing-dots span {
    width: 7px; height: 7px;
    background: var(--accent);
    border-radius: 50%;
    animation: bounce 1.2s infinite;
  }
  .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
  .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-7px); opacity: 1; }
  }

  /* â”€â”€â”€ INPUT AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .input-area {
    padding: 16px 28px 20px;
    border-top: 1px solid var(--border);
    background: rgba(10,10,15,0.8);
    backdrop-filter: blur(12px);
    flex-shrink: 0;
  }
  .input-wrap {
    display: flex;
    gap: 10px;
    align-items: flex-end;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 10px 12px 10px 18px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .input-wrap:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  #msg-input {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13.5px;
    resize: none;
    max-height: 180px;
    line-height: 1.6;
  }
  #msg-input::placeholder { color: var(--text-dimmer); }
  .send-btn {
    width: 38px; height: 38px;
    background: linear-gradient(135deg, var(--accent), #9b5fff);
    border: none;
    border-radius: 10px;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.15s, box-shadow 0.2s, opacity 0.2s;
    flex-shrink: 0;
    box-shadow: 0 4px 14px var(--accent-glow);
  }
  .send-btn:hover { transform: scale(1.05); }
  .send-btn:active { transform: scale(0.97); }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .input-hint {
    margin-top: 8px;
    font-size: 10.5px;
    color: var(--text-dimmer);
    text-align: center;
  }
  .input-hint span { color: var(--accent); }

  /* â”€â”€â”€ API KEY MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(6px);
    z-index: 200;
    display: flex; align-items: center; justify-content: center;
  }
  .modal-box {
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 18px;
    padding: 34px;
    width: 440px;
    box-shadow: 0 0 60px var(--accent-glow);
    animation: fadeUp 0.35s cubic-bezier(0.16,1,0.3,1) both;
  }
  .modal-title { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; margin-bottom: 8px; }
  .modal-sub { font-size: 12px; color: var(--text-dim); margin-bottom: 22px; line-height: 1.7; }
  .modal-sub a { color: var(--accent); text-decoration: none; }
  .modal-sub a:hover { text-decoration: underline; }
  .modal-input {
    width: 100%;
    padding: 12px 16px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    outline: none;
    margin-bottom: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .modal-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
  .modal-save {
    width: 100%;
    padding: 13px;
    background: linear-gradient(135deg, var(--accent), #9b5fff);
    border: none;
    border-radius: 10px;
    color: #fff;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 4px 16px var(--accent-glow);
    transition: transform 0.15s, box-shadow 0.2s;
  }
  .modal-save:hover { transform: translateY(-1px); }

  /* no-select util */
  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- â”€â”€â”€ AUTH SCREEN â”€â”€â”€ -->
<div id="auth-screen">
  <div class="auth-grid"></div>
  <div class="auth-box">
    <div class="auth-logo">ThumbAI</div>
    <div class="auth-tagline">Generate thumbnails & chat with AI</div>
    <div class="tab-row">
      <button class="tab-btn active" id="tab-login" onclick="switchTab('login')">Login</button>
      <button class="tab-btn" id="tab-register" onclick="switchTab('register')">Register</button>
    </div>
    <div class="auth-field">
      <label>Username</label>
      <input type="text" id="auth-username" placeholder="your_username" autocomplete="username" />
    </div>
    <div class="auth-field">
      <label>Password</label>
      <input type="password" id="auth-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
    </div>
    <div class="auth-field hidden" id="confirm-field">
      <label>Confirm Password</label>
      <input type="password" id="auth-confirm" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
    </div>
    <button class="auth-submit" id="auth-submit-btn" onclick="handleAuth()">Login</button>
    <div class="auth-error" id="auth-error"></div>
  </div>
</div>

<!-- â”€â”€â”€ API KEY MODAL â”€â”€â”€ -->
<div class="modal-overlay hidden" id="api-modal">
  <div class="modal-box">
    <div class="modal-title">ğŸ”‘ Enter your API Key</div>
    <div class="modal-sub">
      ThumbAI uses the <span style="color:var(--accent)">Anthropic Claude</span> API to power chats and thumbnail generation.<br/>
      Get your free key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>. Your key is stored locally only.
    </div>
    <input class="modal-input" type="password" id="api-key-input" placeholder="sk-ant-..." />
    <button class="modal-save" onclick="saveApiKey()">Save & Start Chatting</button>
  </div>
</div>

<!-- â”€â”€â”€ APP â”€â”€â”€ -->
<div id="app" class="hidden">
  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">âœ¦ ThumbAI</div>
      <button class="new-chat-btn" onclick="newChat()">
        <span>ï¼‹</span> New Chat
      </button>
    </div>
    <div class="chat-list-label">Your Chats</div>
    <div id="chat-list"></div>
    <div class="sidebar-footer">
      <div class="user-avatar" id="user-avatar-text">?</div>
      <div class="user-info">
        <div class="user-name" id="user-display-name">â€”</div>
        <div class="user-sub">ThumbAI Member</div>
      </div>
      <button class="logout-btn" onclick="logout()">Out</button>
    </div>
  </div>

  <!-- MAIN -->
  <div id="main">
    <div class="chat-topbar">
      <div class="chat-title" id="chat-topbar-title">Select or create a chat</div>
      <div class="chat-badge">âœ¦ AI + Thumbnails</div>
    </div>
    <div id="messages"></div>
    <div class="input-area">
      <div class="input-wrap">
        <textarea id="msg-input" rows="1" placeholder="Ask anything or say 'make a thumbnail for my gaming channel'..."></textarea>
        <button class="send-btn" id="send-btn" onclick="sendMessage()" title="Send">â¤</button>
      </div>
      <div class="input-hint">Try: <span>"thumbnail for a lo-fi music video"</span> or <span>"thumbnail for tech review YouTube channel"</span></div>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentUser = null;
let currentChatId = null;
let isTyping = false;
let authMode = 'login';

function getUsers() {
  return JSON.parse(localStorage.getItem('thumbai_users') || '{}');
}
function saveUsers(u) {
  localStorage.setItem('thumbai_users', JSON.stringify(u));
}
function getUserData(username) {
  const all = JSON.parse(localStorage.getItem('thumbai_data') || '{}');
  return all[username] || { chats: {} };
}
function saveUserData(username, data) {
  const all = JSON.parse(localStorage.getItem('thumbai_data') || '{}');
  all[username] = data;
  localStorage.setItem('thumbai_data', JSON.stringify(all));
}
function getApiKey() {
  return localStorage.getItem('thumbai_apikey_' + currentUser) || '';
}
function setApiKey(key) {
  localStorage.setItem('thumbai_apikey_' + currentUser, key);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(mode) {
  authMode = mode;
  document.getElementById('tab-login').classList.toggle('active', mode === 'login');
  document.getElementById('tab-register').classList.toggle('active', mode === 'register');
  document.getElementById('confirm-field').classList.toggle('hidden', mode === 'login');
  document.getElementById('auth-submit-btn').textContent = mode === 'login' ? 'Login' : 'Create Account';
  document.getElementById('auth-error').textContent = '';
}

function handleAuth() {
  const username = document.getElementById('auth-username').value.trim().toLowerCase();
  const password = document.getElementById('auth-password').value;
  const confirm = document.getElementById('auth-confirm').value;
  const err = document.getElementById('auth-error');

  if (!username || !password) { err.textContent = 'Please fill in all fields.'; return; }

  const users = getUsers();

  if (authMode === 'register') {
    if (password !== confirm) { err.textContent = 'Passwords do not match.'; return; }
    if (password.length < 4) { err.textContent = 'Password must be at least 4 characters.'; return; }
    if (users[username]) { err.textContent = 'Username already taken.'; return; }
    users[username] = btoa(password);
    saveUsers(users);
    err.style.color = '#6be585';
    err.textContent = 'Account created! Logging in...';
    setTimeout(() => loginUser(username), 700);
  } else {
    if (!users[username] || users[username] !== btoa(password)) {
      err.textContent = 'Invalid username or password.';
      return;
    }
    loginUser(username);
  }
}

function loginUser(username) {
  currentUser = username;
  localStorage.setItem('thumbai_session', username);
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.remove('hidden');
  document.getElementById('user-avatar-text').textContent = username[0].toUpperCase();
  document.getElementById('user-display-name').textContent = username;
  renderChatList();
  if (!getApiKey()) {
    document.getElementById('api-modal').classList.remove('hidden');
  }
}

function logout() {
  currentUser = null; currentChatId = null;
  localStorage.removeItem('thumbai_session');
  document.getElementById('app').classList.add('hidden');
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('auth-error').textContent = '';
  document.getElementById('auth-username').value = '';
  document.getElementById('auth-password').value = '';
  document.getElementById('auth-confirm').value = '';
}

function saveApiKey() {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key.startsWith('sk-')) { alert('Please enter a valid Anthropic API key (starts with sk-)'); return; }
  setApiKey(key);
  document.getElementById('api-modal').classList.add('hidden');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT MANAGEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderChatList() {
  const data = getUserData(currentUser);
  const list = document.getElementById('chat-list');
  list.innerHTML = '';
  const chatIds = Object.keys(data.chats).sort((a, b) => {
    return (data.chats[b].updatedAt || 0) - (data.chats[a].updatedAt || 0);
  });
  if (chatIds.length === 0) {
    list.innerHTML = '<div style="padding:16px 12px;font-size:11.5px;color:var(--text-dimmer);text-align:center;">No chats yet.<br/>Start a new one!</div>';
    return;
  }
  chatIds.forEach(id => {
    const chat = data.chats[id];
    const el = document.createElement('div');
    el.className = 'chat-item' + (id === currentChatId ? ' active' : '');
    el.dataset.id = id;
    el.innerHTML = `
      <span class="chat-item-icon">ğŸ’¬</span>
      <span class="chat-item-name">${escapeHtml(chat.title || 'New Chat')}</span>
      <button class="chat-delete" onclick="deleteChat(event,'${id}')" title="Delete">âœ•</button>
    `;
    el.addEventListener('click', (e) => { if (!e.target.classList.contains('chat-delete')) selectChat(id); });
    list.appendChild(el);
  });
}

function newChat() {
  const data = getUserData(currentUser);
  const id = 'chat_' + Date.now();
  data.chats[id] = { title: 'New Chat', messages: [], createdAt: Date.now(), updatedAt: Date.now() };
  saveUserData(currentUser, data);
  selectChat(id);
  renderChatList();
}

function selectChat(id) {
  currentChatId = id;
  const data = getUserData(currentUser);
  const chat = data.chats[id];
  document.getElementById('chat-topbar-title').textContent = chat.title || 'New Chat';
  renderMessages(chat.messages || []);
  renderChatList();
}

function deleteChat(e, id) {
  e.stopPropagation();
  const data = getUserData(currentUser);
  delete data.chats[id];
  saveUserData(currentUser, data);
  if (currentChatId === id) {
    currentChatId = null;
    document.getElementById('messages').innerHTML = renderEmptyState();
    document.getElementById('chat-topbar-title').textContent = 'Select or create a chat';
  }
  renderChatList();
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MESSAGES RENDERING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderEmptyState() {
  return `
    <div class="empty-state">
      <div class="empty-icon">ğŸ–¼ï¸</div>
      <div class="empty-title">ThumbAI</div>
      <div class="empty-sub">Chat with AI and generate stunning thumbnails for YouTube, Twitch, podcasts, blogs â€” anything.</div>
      <div class="empty-tips">
        <span class="tip-chip" onclick="usePrompt(this)">Gaming channel thumbnail</span>
        <span class="tip-chip" onclick="usePrompt(this)">Lo-fi music video cover</span>
        <span class="tip-chip" onclick="usePrompt(this)">Tech review thumbnail</span>
        <span class="tip-chip" onclick="usePrompt(this)">Podcast episode art</span>
        <span class="tip-chip" onclick="usePrompt(this)">Dark fantasy movie poster</span>
        <span class="tip-chip" onclick="usePrompt(this)">Motivational YouTube thumbnail</span>
      </div>
    </div>`;
}

function usePrompt(el) {
  if (!currentChatId) newChat();
  const input = document.getElementById('msg-input');
  input.value = 'Create a thumbnail for: ' + el.textContent;
  input.focus();
}

function renderMessages(messages) {
  const container = document.getElementById('messages');
  if (!messages || messages.length === 0) {
    container.innerHTML = renderEmptyState();
    return;
  }
  container.innerHTML = '';
  messages.forEach(m => appendMessage(m, false));
  scrollBottom();
}

function appendMessage(msg, animate = true) {
  const container = document.getElementById('messages');
  // clear empty state
  const empty = container.querySelector('.empty-state');
  if (empty) empty.remove();

  const el = document.createElement('div');
  el.className = 'msg ' + msg.role;

  const avatarIcon = msg.role === 'ai' ? 'âœ¦' : 'ğŸ‘¤';
  let bubbleContent = `<div class="msg-bubble">${formatText(msg.content)}`;

  // render thumbnail if present
  if (msg.imagePrompt) {
    const encoded = encodeURIComponent(msg.imagePrompt);
    const seed = Math.floor(Math.random() * 100000);
    const imgUrl = `https://image.pollinations.ai/prompt/${encoded}?width=1280&height=720&seed=${seed}&nologo=true`;
    bubbleContent += `
      <div class="thumb-card">
        <img src="${imgUrl}" alt="Generated Thumbnail" class="loading" onload="this.classList.remove('loading')" onerror="this.src='data:image/svg+xml,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;1280&quot; height=&quot;720&quot;><rect width=&quot;100%&quot; height=&quot;100%&quot; fill=&quot;%231a1a24&quot;/><text x=&quot;50%&quot; y=&quot;50%&quot; fill=&quot;%237a7a9a&quot; text-anchor=&quot;middle&quot; font-family=&quot;sans-serif&quot; font-size=&quot;24&quot;>Failed to load image</text></svg>'" />
        <div class="thumb-meta">
          <span class="thumb-label">ğŸ–¼ ${escapeHtml(msg.imagePrompt)}</span>
          <a class="thumb-dl" href="${imgUrl}" target="_blank" download>â†“ Open</a>
        </div>
      </div>`;
  }

  bubbleContent += `</div>`;

  el.innerHTML = `
    <div class="msg-avatar">${avatarIcon}</div>
    ${bubbleContent}`;

  if (!animate) el.style.animation = 'none';
  container.appendChild(el);
  scrollBottom();
}

function formatText(text) {
  if (!text) return '';
  return escapeHtml(text)
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`([^`]+)`/g, '<code style="background:var(--surface3);padding:2px 6px;border-radius:4px;font-size:12px;">$1</code>')
    .replace(/\n/g, '<br/>');
}

function scrollBottom() {
  const c = document.getElementById('messages');
  c.scrollTop = c.scrollHeight;
}

function showTyping() {
  const container = document.getElementById('messages');
  const empty = container.querySelector('.empty-state');
  if (empty) empty.remove();
  const el = document.createElement('div');
  el.className = 'msg ai';
  el.id = 'typing-indicator';
  el.innerHTML = `<div class="msg-avatar">âœ¦</div><div class="msg-bubble"><div class="typing-dots"><span></span><span></span><span></span></div></div>`;
  container.appendChild(el);
  scrollBottom();
}
function hideTyping() {
  const el = document.getElementById('typing-indicator');
  if (el) el.remove();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEND MESSAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sendMessage() {
  if (isTyping) return;
  if (!currentChatId) newChat();

  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text) return;

  const apiKey = getApiKey();
  if (!apiKey) {
    document.getElementById('api-modal').classList.remove('hidden');
    return;
  }

  input.value = '';
  autoResize(input);

  const userMsg = { role: 'user', content: text };
  saveMessageToChat(userMsg);
  appendMessage(userMsg);
  updateChatTitle(text);

  isTyping = true;
  document.getElementById('send-btn').disabled = true;
  showTyping();

  try {
    const data = getUserData(currentUser);
    const chat = data.chats[currentChatId];
    const history = (chat.messages || []).map(m => ({
      role: m.role === 'ai' ? 'assistant' : 'user',
      content: m.content
    }));

    const systemPrompt = `You are ThumbAI, a creative assistant that chats and generates thumbnails.
When the user asks you to create/generate/make a thumbnail, image, cover, poster, or any visual:
1. Write 2-3 enthusiastic sentences about the design you'll create
2. End your text response with a line that says exactly: GENERATE_THUMB: [detailed visual description]

Example: GENERATE_THUMB: A dramatic YouTube gaming thumbnail with a dark background, glowing neon blue text saying 'FINAL BOSS', a shocked gamer face on the left, explosive particles and lightning effects, cinematic widescreen format, ultra HD quality

Make the GENERATE_THUMB description detailed, visual, and optimized for image generation.
For non-thumbnail requests, just chat normally and helpfully.`;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1024,
        system: systemPrompt,
        messages: history
      })
    });

    const result = await response.json();
    hideTyping();

    if (result.error) {
      const errMsg = { role: 'ai', content: `âš ï¸ API Error: ${result.error.message}` };
      saveMessageToChat(errMsg);
      appendMessage(errMsg);
    } else {
      let aiText = result.content?.[0]?.text || 'Sorry, I had trouble responding.';

      // extract GENERATE_THUMB
      let imagePrompt = null;
      const thumbMatch = aiText.match(/GENERATE_THUMB:\s*(.+)/i);
      if (thumbMatch) {
        imagePrompt = thumbMatch[1].trim();
        aiText = aiText.replace(/GENERATE_THUMB:\s*.+/i, '').trim();
      }

      const aiMsg = { role: 'ai', content: aiText, imagePrompt };
      saveMessageToChat(aiMsg);
      appendMessage(aiMsg);
    }
  } catch (err) {
    hideTyping();
    const errMsg = { role: 'ai', content: `âš ï¸ Network error. Check your API key and connection.` };
    saveMessageToChat(errMsg);
    appendMessage(errMsg);
  }

  isTyping = false;
  document.getElementById('send-btn').disabled = false;
}

function saveMessageToChat(msg) {
  const data = getUserData(currentUser);
  if (!data.chats[currentChatId]) return;
  data.chats[currentChatId].messages = data.chats[currentChatId].messages || [];
  data.chats[currentChatId].messages.push(msg);
  data.chats[currentChatId].updatedAt = Date.now();
  saveUserData(currentUser, data);
}

function updateChatTitle(text) {
  const data = getUserData(currentUser);
  if (!data.chats[currentChatId]) return;
  if (data.chats[currentChatId].title === 'New Chat') {
    data.chats[currentChatId].title = text.length > 36 ? text.substring(0, 36) + 'â€¦' : text;
    saveUserData(currentUser, data);
    document.getElementById('chat-topbar-title').textContent = data.chats[currentChatId].title;
    renderChatList();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUT AUTO-RESIZE + KEYBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 180) + 'px';
}

document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('msg-input');
  input.addEventListener('input', () => autoResize(input));
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // auth enter key
  ['auth-username', 'auth-password', 'auth-confirm'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleAuth(); });
  });

  // check existing session
  const session = localStorage.getItem('thumbai_session');
  if (session) {
    const users = getUsers();
    if (users[session]) loginUser(session);
  }

  // show empty state initially
  document.getElementById('messages').innerHTML = renderEmptyState();
});
</script>
</body>
</html>
