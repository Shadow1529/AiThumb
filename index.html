<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Aura â€” AI Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg:          #f5f0eb;
    --bg2:         #ede8e1;
    --sidebar-bg:  #1c1917;
    --sidebar2:    #28231f;
    --sidebar3:    #332e29;
    --surface:     #ffffff;
    --surface2:    #faf7f4;
    --accent:      #d4713a;
    --accent-dim:  rgba(212,113,58,0.12);
    --accent-glow: rgba(212,113,58,0.22);
    --text:        #1c1917;
    --text-mid:    #6b6358;
    --text-dim:    #a39890;
    --text-inv:    #f5ede4;
    --text-inv-dim:#a09188;
    --border:      rgba(28,25,23,0.08);
    --border-dark: rgba(255,255,255,0.06);
    --radius:      12px;
    --sidebar-w:   260px;
    --T:           0.18s cubic-bezier(0.4,0,0.2,1);
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
  }

  /* â”€â”€ AUTH â”€â”€ */
  #auth-screen {
    position: fixed; inset: 0;
    display: flex; align-items: center; justify-content: center;
    background: var(--bg); z-index: 200;
  }
  .blob {
    position: absolute; border-radius: 50%; filter: blur(90px); pointer-events: none;
  }
  .blob1 { width:500px;height:500px;background:rgba(212,113,58,0.09);top:-120px;right:-80px; }
  .blob2 { width:380px;height:380px;background:rgba(28,25,23,0.04);bottom:-80px;left:-60px; }

  .auth-card {
    position: relative; width: 420px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px; padding: 44px 42px 40px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04),0 8px 32px rgba(28,25,23,0.08),0 32px 80px rgba(28,25,23,0.06);
    animation: slideUp 0.5s cubic-bezier(0.16,1,0.3,1) both;
  }
  @keyframes slideUp { from{opacity:0;transform:translateY(22px)}to{opacity:1;transform:none} }

  .auth-wordmark {
    font-family: 'Lora', serif; font-size: 28px; font-weight: 600;
    color: var(--text); letter-spacing: -0.5px; margin-bottom: 4px;
  }
  .auth-wordmark span { color: var(--accent); }
  .auth-sub { font-size: 13px; color: var(--text-mid); margin-bottom: 30px; }

  .tab-row {
    display: flex; background: var(--bg2); border-radius: 10px;
    padding: 3px; margin-bottom: 24px; gap: 2px;
  }
  .tab-btn {
    flex: 1; padding: 9px; border: none; background: transparent;
    color: var(--text-mid); font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 13px; font-weight: 500; cursor: pointer;
    border-radius: 8px; transition: var(--T);
  }
  .tab-btn.active {
    background: var(--surface); color: var(--text); font-weight: 600;
    box-shadow: 0 1px 4px rgba(0,0,0,0.07);
  }

  .field { margin-bottom: 13px; }
  .field label {
    display: block; font-size: 11.5px; font-weight: 600;
    color: var(--text-mid); letter-spacing: 0.3px; margin-bottom: 6px;
  }
  .field input {
    width: 100%; padding: 11px 14px; background: var(--bg2);
    border: 1.5px solid transparent; border-radius: 10px; color: var(--text);
    font-family: 'Plus Jakarta Sans', sans-serif; font-size: 14px;
    outline: none; transition: var(--T); -webkit-appearance: none;
  }
  .field input:focus {
    background: var(--surface); border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  .field input::placeholder { color: var(--text-dim); }

  .auth-btn {
    width: 100%; padding: 13px; margin-top: 6px;
    background: var(--text); border: none; border-radius: 10px;
    color: #fff; font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 14.5px; font-weight: 600; cursor: pointer;
    transition: var(--T);
  }
  .auth-btn:hover { background: #2e2924; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(28,25,23,0.16); }
  .auth-btn:active { transform: none; }
  .auth-err { margin-top: 12px; font-size: 12.5px; text-align: center; min-height: 18px; color: #b91c1c; }

  /* â”€â”€ APP â”€â”€ */
  #app { display: flex; width: 100%; height: 100vh; }

  /* â”€â”€ SIDEBAR â”€â”€ */
  #sidebar {
    width: var(--sidebar-w); min-width: var(--sidebar-w);
    background: var(--sidebar-bg); display: flex; flex-direction: column;
    height: 100vh; overflow: hidden;
  }
  .sb-top { padding: 20px 14px 12px; }
  .sb-wordmark {
    font-family: 'Lora', serif; font-size: 18px; font-weight: 600;
    color: var(--text-inv); padding: 0 4px; margin-bottom: 14px;
  }
  .sb-wordmark span { color: var(--accent); }
  .new-btn {
    width: 100%; padding: 10px 14px; background: var(--sidebar2);
    border: 1px solid var(--border-dark); border-radius: 10px;
    color: var(--text-inv); font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 13px; font-weight: 500; cursor: pointer;
    display: flex; align-items: center; gap: 9px;
    transition: var(--T); text-align: left;
  }
  .new-btn:hover { background: var(--sidebar3); border-color: rgba(255,255,255,0.09); }
  .new-btn-ico {
    width: 22px; height: 22px; background: var(--accent); border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0; color: #fff; line-height: 1;
  }

  .sec-label {
    padding: 14px 18px 5px; font-size: 10px; font-weight: 700;
    color: var(--text-inv-dim); text-transform: uppercase; letter-spacing: 1.2px;
  }

  #chat-list { flex: 1; overflow-y: auto; padding: 2px 8px 8px; }
  #chat-list::-webkit-scrollbar { width: 3px; }
  #chat-list::-webkit-scrollbar-thumb { background: var(--sidebar3); border-radius: 3px; }

  .chat-row {
    display: flex; align-items: center; padding: 9px 10px;
    border-radius: 9px; cursor: pointer; gap: 9px; margin-bottom: 1px;
    border: 1px solid transparent; transition: var(--T);
  }
  .chat-row:hover { background: var(--sidebar2); }
  .chat-row.active { background: var(--sidebar2); border-color: rgba(255,255,255,0.05); }
  .chat-row-ico { font-size: 13px; flex-shrink: 0; opacity: 0.55; }
  .chat-row-name {
    font-size: 13px; color: var(--text-inv);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    flex: 1; font-weight: 400;
  }
  .chat-row.active .chat-row-name { font-weight: 500; }
  .chat-row-del {
    opacity: 0; background: none; border: none;
    color: var(--text-inv-dim); cursor: pointer;
    font-size: 12px; padding: 2px 5px; border-radius: 4px;
    transition: opacity var(--T), color var(--T); flex-shrink: 0; line-height: 1;
  }
  .chat-row:hover .chat-row-del { opacity: 1; }
  .chat-row-del:hover { color: #fca5a5; }

  .sb-bottom { padding: 12px 12px 16px; border-top: 1px solid var(--border-dark); }
  .user-row { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 9px; }
  .user-av {
    width: 32px; height: 32px; border-radius: 50%; background: var(--accent);
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 700; color: #fff; flex-shrink: 0;
    font-family: 'Lora', serif;
  }
  .user-meta { flex: 1; overflow: hidden; }
  .user-nm { font-size: 13px; color: var(--text-inv); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .logout-btn {
    font-size: 11px; color: var(--text-inv-dim); background: none; border: none;
    cursor: pointer; font-family: 'Plus Jakarta Sans', sans-serif; transition: color var(--T); padding: 0;
  }
  .logout-btn:hover { color: #fca5a5; }

  /* â”€â”€ MAIN â”€â”€ */
  #main { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

  .topbar {
    display: flex; align-items: center; padding: 14px 24px;
    background: var(--surface); border-bottom: 1px solid var(--border);
    gap: 14px; flex-shrink: 0;
  }
  .topbar-title {
    font-family: 'Lora', serif; font-size: 15px; font-weight: 500;
    color: var(--text); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .status-chip {
    display: flex; align-items: center; gap: 5px;
    padding: 5px 12px; background: var(--bg2); border-radius: 20px;
    font-size: 11.5px; color: var(--text-mid); font-weight: 500;
    border: 1px solid var(--border); white-space: nowrap;
  }
  .status-dot {
    width: 6px; height: 6px; border-radius: 50%; background: #22c55e;
    box-shadow: 0 0 6px #22c55e; animation: pulse 2.5s ease-in-out infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.35} }

  /* messages */
  #messages { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
  #messages::-webkit-scrollbar { width: 5px; }
  #messages::-webkit-scrollbar-thumb { background: var(--bg2); border-radius: 5px; }

  /* empty */
  .empty-wrap {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 40px 24px; gap: 10px;
  }
  .empty-wordmark {
    font-family: 'Lora', serif; font-size: 38px; font-weight: 600;
    color: var(--text); letter-spacing: -1px; margin-bottom: 8px;
  }
  .empty-wordmark span { color: var(--accent); }
  .empty-desc {
    font-size: 15px; color: var(--text-mid); text-align: center;
    max-width: 420px; line-height: 1.75; font-weight: 400;
  }
  .starter-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 10px; margin-top: 22px; width: 100%; max-width: 560px;
  }
  .starter {
    padding: 15px 16px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; cursor: pointer; font-size: 13px;
    color: var(--text-mid); transition: var(--T); line-height: 1.55;
  }
  .starter strong { display: block; color: var(--text); font-size: 13.5px; margin-bottom: 3px; font-weight: 600; }
  .starter:hover {
    border-color: rgba(212,113,58,0.35); background: #fff;
    box-shadow: 0 4px 18px rgba(212,113,58,0.07); transform: translateY(-1px);
  }

  /* message rows */
  .msg-wrap { padding: 26px 0; animation: msgIn 0.26s ease both; }
  @keyframes msgIn { from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none} }
  .msg-wrap.user { background: transparent; }
  .msg-wrap.ai { background: var(--surface2); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }

  .msg-inner {
    max-width: 720px; margin: 0 auto;
    padding: 0 28px; display: flex; gap: 16px; align-items: flex-start;
  }
  .msg-av {
    width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700; margin-top: 1px;
  }
  .msg-wrap.user .msg-av { background: var(--text); color: #fff; font-family: 'Lora', serif; }
  .msg-wrap.ai  .msg-av { background: var(--accent); color: #fff; font-family: 'Lora', serif; font-size: 11px; }
  .msg-body { flex: 1; min-width: 0; }
  .msg-author {
    font-size: 11.5px; font-weight: 700; color: var(--text-dim);
    text-transform: uppercase; letter-spacing: 0.9px; margin-bottom: 8px;
  }
  .msg-text { font-size: 15px; line-height: 1.8; color: var(--text); }
  .msg-text strong { font-weight: 600; }
  .msg-text em { font-style: italic; }
  .msg-text code {
    background: var(--bg2); border: 1px solid var(--border);
    padding: 2px 7px; border-radius: 5px;
    font-family: 'Courier New', monospace; font-size: 13px; color: var(--accent);
  }
  .msg-text pre {
    background: var(--sidebar-bg); border-radius: 10px;
    padding: 16px 18px; margin: 14px 0; overflow-x: auto;
  }
  .msg-text pre code {
    background: none; border: none; padding: 0;
    color: #e8d5c4; font-size: 13px;
  }

  /* typing */
  .typing-bar { display: flex; gap: 4px; align-items: center; padding: 6px 0; }
  .typing-bar span {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--accent); animation: tb 1.2s infinite;
  }
  .typing-bar span:nth-child(2){animation-delay:.18s}
  .typing-bar span:nth-child(3){animation-delay:.36s}
  @keyframes tb{0%,60%,100%{transform:translateY(0);opacity:.3}30%{transform:translateY(-6px);opacity:1}}

  /* input */
  .input-zone {
    padding: 14px 24px 20px; border-top: 1px solid var(--border);
    background: var(--bg); flex-shrink: 0;
  }
  .input-center { max-width: 720px; margin: 0 auto; }
  .input-box {
    display: flex; gap: 10px; align-items: flex-end;
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: 14px; padding: 12px 12px 12px 18px;
    box-shadow: 0 2px 12px rgba(28,25,23,0.05);
    transition: border-color var(--T), box-shadow var(--T);
  }
  .input-box:focus-within {
    border-color: rgba(212,113,58,0.4);
    box-shadow: 0 2px 12px rgba(28,25,23,0.05), 0 0 0 3px var(--accent-glow);
  }
  #msg-input {
    flex: 1; background: none; border: none; outline: none;
    color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 14.5px; resize: none; max-height: 200px; line-height: 1.65;
  }
  #msg-input::placeholder { color: var(--text-dim); }
  .send-btn {
    width: 36px; height: 36px; flex-shrink: 0; background: var(--text);
    border: none; border-radius: 9px; color: #fff; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: var(--T);
  }
  .send-btn:hover { background: var(--accent); transform: scale(1.05); }
  .send-btn:active { transform: scale(0.96); }
  .send-btn:disabled { opacity: 0.25; cursor: not-allowed; transform: none; background: var(--text); }
  .input-note { text-align: center; font-size: 11px; color: var(--text-dim); margin-top: 9px; }

  .hidden { display: none !important; }
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth-screen">
  <div class="blob blob1"></div>
  <div class="blob blob2"></div>
  <div class="auth-card">
    <div class="auth-wordmark">Aur<span>a</span></div>
    <div class="auth-sub">Your personal AI assistant</div>
    <div class="tab-row">
      <button class="tab-btn active" id="tab-login" onclick="switchTab('login')">Sign in</button>
      <button class="tab-btn" id="tab-reg" onclick="switchTab('register')">Create account</button>
    </div>
    <div class="field">
      <label>Username</label>
      <input id="au" type="text" placeholder="your_username" autocomplete="username" />
    </div>
    <div class="field">
      <label>Password</label>
      <input id="ap" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
    </div>
    <div class="field hidden" id="cw">
      <label>Confirm password</label>
      <input id="ac" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
    </div>
    <button class="auth-btn" id="auth-btn" onclick="handleAuth()">Sign in</button>
    <div class="auth-err" id="auth-err"></div>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div id="sidebar">
    <div class="sb-top">
      <div class="sb-wordmark">Aur<span>a</span></div>
      <button class="new-btn" onclick="newChat()">
        <div class="new-btn-ico">+</div>New chat
      </button>
    </div>
    <div class="sec-label">Recents</div>
    <div id="chat-list"></div>
    <div class="sb-bottom">
      <div class="user-row">
        <div class="user-av" id="u-av">?</div>
        <div class="user-meta">
          <div class="user-nm" id="u-nm">â€”</div>
          <button class="logout-btn" onclick="logout()">Sign out</button>
        </div>
      </div>
    </div>
  </div>

  <div id="main">
    <div class="topbar">
      <div class="topbar-title" id="top-title">New conversation</div>
      <div class="status-chip"><div class="status-dot"></div>Aura AI Â· Online</div>
    </div>
    <div id="messages"></div>
    <div class="input-zone">
      <div class="input-center">
        <div class="input-box">
          <textarea id="msg-input" rows="1" placeholder="Message Auraâ€¦"></textarea>
          <button class="send-btn" id="send-btn" onclick="send()">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
        <div class="input-note">Shift + Enter for a new line</div>
      </div>
    </div>
  </div>
</div>

<script>
/* â”€â”€ STORAGE â”€â”€ */
const getUsers   = () => JSON.parse(localStorage.getItem('aura_u')||'{}');
const saveUsers  = u  => localStorage.setItem('aura_u', JSON.stringify(u));
const getAllData  = () => JSON.parse(localStorage.getItem('aura_d')||'{}');
const saveAll    = d  => localStorage.setItem('aura_d', JSON.stringify(d));
const getData    = u  => (getAllData()[u]||{chats:{}});
const saveData   = (u,d) => { const a=getAllData(); a[u]=d; saveAll(a); };

let me=null, cid=null, busy=false, mode='login';

/* â”€â”€ AUTH â”€â”€ */
function switchTab(m) {
  mode = m;
  document.getElementById('tab-login').classList.toggle('active', m==='login');
  document.getElementById('tab-reg').classList.toggle('active', m==='register');
  document.getElementById('cw').classList.toggle('hidden', m==='login');
  document.getElementById('auth-btn').textContent = m==='login' ? 'Sign in' : 'Create account';
  document.getElementById('auth-err').textContent = '';
}

function handleAuth() {
  const u = document.getElementById('au').value.trim().toLowerCase();
  const p = document.getElementById('ap').value;
  const c = document.getElementById('ac').value;
  const e = document.getElementById('auth-err');
  e.style.color = '#b91c1c';
  if (!u||!p) { e.textContent='Please fill in all fields.'; return; }
  const users = getUsers();
  if (mode==='register') {
    if (p!==c) { e.textContent='Passwords do not match.'; return; }
    if (p.length<4) { e.textContent='Password must be 4+ characters.'; return; }
    if (users[u]) { e.textContent='Username already taken.'; return; }
    users[u]=btoa(p); saveUsers(users);
    e.style.color='#16a34a'; e.textContent='Account created!';
    setTimeout(()=>enter(u), 600);
  } else {
    if (!users[u]||users[u]!==btoa(p)) { e.textContent='Incorrect username or password.'; return; }
    enter(u);
  }
}

function enter(u) {
  me=u;
  localStorage.setItem('aura_s', u);
  document.getElementById('auth-screen').style.display='none';
  document.getElementById('app').classList.remove('hidden');
  document.getElementById('u-av').textContent=u[0].toUpperCase();
  document.getElementById('u-nm').textContent=u;
  renderList();
  showEmpty();
}

function logout() {
  me=null; cid=null;
  localStorage.removeItem('aura_s');
  document.getElementById('app').classList.add('hidden');
  document.getElementById('auth-screen').style.display='flex';
  ['au','ap','ac'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('auth-err').textContent='';
}

/* â”€â”€ CHAT LIST â”€â”€ */
function renderList() {
  const data=getData(me), list=document.getElementById('chat-list');
  list.innerHTML='';
  const ids=Object.keys(data.chats).sort((a,b)=>(data.chats[b].updatedAt||0)-(data.chats[a].updatedAt||0));
  if (!ids.length) {
    list.innerHTML='<div style="padding:16px 18px;font-size:12.5px;color:var(--text-inv-dim);line-height:1.6;">No chats yet.<br/>Click + to start one.</div>';
    return;
  }
  ids.forEach(id=>{
    const chat=data.chats[id], el=document.createElement('div');
    el.className='chat-row'+(id===cid?' active':'');
    el.innerHTML=`
      <span class="chat-row-ico">ðŸ’¬</span>
      <span class="chat-row-name">${esc(chat.title||'New chat')}</span>
      <button class="chat-row-del" onclick="delChat(event,'${id}')">âœ•</button>`;
    el.addEventListener('click',e=>{ if(!e.target.classList.contains('chat-row-del')) openChat(id); });
    list.appendChild(el);
  });
}

function newChat() {
  const data=getData(me), id='c'+Date.now();
  data.chats[id]={title:'New chat',messages:[],createdAt:Date.now(),updatedAt:Date.now()};
  saveData(me,data); openChat(id);
}

function openChat(id) {
  cid=id;
  const chat=getData(me).chats[id];
  document.getElementById('top-title').textContent=chat.title||'New chat';
  renderMsgs(chat.messages||[]);
  renderList();
  document.getElementById('msg-input').focus();
}

function delChat(e,id) {
  e.stopPropagation();
  const data=getData(me); delete data.chats[id]; saveData(me,data);
  if (cid===id) { cid=null; showEmpty(); document.getElementById('top-title').textContent='New conversation'; }
  renderList();
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* â”€â”€ RENDER â”€â”€ */
function showEmpty() {
  document.getElementById('messages').innerHTML=`
    <div class="empty-wrap">
      <div class="empty-wordmark">Aur<span>a</span></div>
      <div class="empty-desc">Ask me anything â€” I'm here to help you think, write, code, and explore ideas.</div>
      <div class="starter-grid">
        <div class="starter" onclick="useStarter(this)"><strong>Explain a concept</strong>How does the internet actually work?</div>
        <div class="starter" onclick="useStarter(this)"><strong>Help me write</strong>Draft a professional email declining a meeting</div>
        <div class="starter" onclick="useStarter(this)"><strong>Brainstorm ideas</strong>Give me 10 creative business ideas for 2025</div>
        <div class="starter" onclick="useStarter(this)"><strong>Debug my code</strong>Explain how async/await works in JavaScript</div>
      </div>
    </div>`;
}

function useStarter(el) {
  if (!cid) newChat();
  const txt=el.childNodes[1].textContent.trim();
  const inp=document.getElementById('msg-input');
  inp.value=txt; autoResize(inp); inp.focus();
}

function renderMsgs(msgs) {
  const c=document.getElementById('messages');
  if (!msgs.length){showEmpty();return;}
  c.innerHTML='';
  msgs.forEach(m=>appendMsg(m,false));
  scrollBot();
}

function appendMsg(msg, anim=true) {
  const c=document.getElementById('messages');
  const empty=c.querySelector('.empty-wrap'); if(empty)empty.remove();
  const wrap=document.createElement('div');
  wrap.className='msg-wrap '+(msg.role==='user'?'user':'ai');
  if(!anim)wrap.style.animation='none';
  const isUser=msg.role==='user';
  wrap.innerHTML=`
    <div class="msg-inner">
      <div class="msg-av">${esc(isUser?me[0].toUpperCase():'A')}</div>
      <div class="msg-body">
        <div class="msg-author">${esc(isUser?me:'Aura')}</div>
        <div class="msg-text">${fmt(msg.content)}</div>
      </div>
    </div>`;
  c.appendChild(wrap); scrollBot();
}

function showTyping() {
  const c=document.getElementById('messages');
  const empty=c.querySelector('.empty-wrap'); if(empty)empty.remove();
  const wrap=document.createElement('div');
  wrap.id='typing-wrap'; wrap.className='msg-wrap ai'; wrap.style.animation='none';
  wrap.innerHTML=`
    <div class="msg-inner">
      <div class="msg-av">A</div>
      <div class="msg-body">
        <div class="msg-author">Aura</div>
        <div class="typing-bar"><span></span><span></span><span></span></div>
      </div>
    </div>`;
  c.appendChild(wrap); scrollBot();
}
function hideTyping(){const e=document.getElementById('typing-wrap');if(e)e.remove();}
function scrollBot(){const c=document.getElementById('messages');c.scrollTop=c.scrollHeight;}

function fmt(raw) {
  let t=esc(raw);
  t=t.replace(/```[\w]*\n?([\s\S]*?)```/g,(_,c)=>`<pre><code>${c.trim()}</code></pre>`);
  t=t.replace(/`([^`]+)`/g,'<code>$1</code>');
  t=t.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  t=t.replace(/\*(.+?)\*/g,'<em>$1</em>');
  t=t.replace(/\n/g,'<br/>');
  return t;
}

/* â”€â”€ SEND â”€â”€ */
async function send() {
  if (busy) return;
  if (!cid) newChat();
  const inp=document.getElementById('msg-input');
  const text=inp.value.trim(); if(!text)return;
  inp.value=''; autoResize(inp);

  const uMsg={role:'user',content:text};
  persist(uMsg); appendMsg(uMsg); maybeTitle(text);

  busy=true; document.getElementById('send-btn').disabled=true; showTyping();

  try {
    const data=getData(me), chat=data.chats[cid];
    const history=(chat.messages||[]).map(m=>({
      role: m.role==='user'?'user':'assistant',
      content: m.content
    }));

    const sys=`You are Aura, a thoughtful and intelligent AI assistant. Be helpful, clear, concise, and warm. You can help with anything â€” writing, coding, analysis, brainstorming, explanations, and more. Never mention that you are based on any particular model. You are simply Aura.`;

    const res=await fetch('https://text.pollinations.ai/',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'openai',
        messages:[{role:'system',content:sys},...history],
        seed:Math.floor(Math.random()*99999)
      })
    });

    if (!res.ok) throw new Error('HTTP '+res.status);
    const reply=(await res.text()).trim();
    hideTyping();
    const aMsg={role:'ai',content:reply};
    persist(aMsg); appendMsg(aMsg);
  } catch(err) {
    hideTyping();
    const aMsg={role:'ai',content:`Something went wrong. The AI may be momentarily busy â€” please try again.\n\n_${err.message}_`};
    persist(aMsg); appendMsg(aMsg);
  }

  busy=false; document.getElementById('send-btn').disabled=false;
  document.getElementById('msg-input').focus();
}

function persist(msg) {
  const data=getData(me); if(!data.chats[cid])return;
  data.chats[cid].messages=data.chats[cid].messages||[];
  data.chats[cid].messages.push(msg);
  data.chats[cid].updatedAt=Date.now();
  saveData(me,data);
}

function maybeTitle(text) {
  const data=getData(me); if(!data.chats[cid])return;
  if (data.chats[cid].title==='New chat') {
    const t=text.length>40?text.slice(0,40)+'â€¦':text;
    data.chats[cid].title=t; saveData(me,data);
    document.getElementById('top-title').textContent=t;
    renderList();
  }
}

function autoResize(el) {
  el.style.height='auto';
  el.style.height=Math.min(el.scrollHeight,200)+'px';
}

document.addEventListener('DOMContentLoaded',()=>{
  const inp=document.getElementById('msg-input');
  inp.addEventListener('input',()=>autoResize(inp));
  inp.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();} });
  ['au','ap','ac'].forEach(id=>{
    const el=document.getElementById(id);
    if(el)el.addEventListener('keydown',e=>{if(e.key==='Enter')handleAuth();});
  });
  const s=localStorage.getItem('aura_s');
  if(s&&getUsers()[s])enter(s);
});
</script>
</body>
</html>
